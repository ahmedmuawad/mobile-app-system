@extends('layouts.app')

@section('title', 'ุนุฑุถ ูุงุชูุฑุฉ ุงูุตูุงูุฉ')

@section('content')
<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">๐งพ ุชูุงุตูู ูุงุชูุฑุฉ ุตูุงูุฉ #{{ $repair->id }}</h3>
            <div class="d-print-none">
                <a href="{{ route('admin.repairs.index') }}" class="btn btn-secondary btn-sm">โฉ๏ธ ุฑุฌูุน</a>
                <a href="{{ route('admin.repairs.edit', $repair->id) }}" class="btn btn-warning btn-sm">โ๏ธ ุชุนุฏูู</a>
                <button onclick="printReceipt('a4')" class="btn btn-primary btn-sm">๐จ๏ธ ุทุจุงุนุฉ A4</button>
                <button onclick="printReceipt('thermal')" class="btn btn-dark btn-sm">๐งพ ุทุจุงุนุฉ ุญุฑุงุฑูุฉ</button>
            </div>
        </div>

        <div class="card-body">

            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>ุงูุนููู:</strong> {{ $repair->customer->name ?? $repair->customer_name ?? '---' }}
                </div>
                <div class="col-md-6">
                    <strong>ุฑูู ุงููุงุชู:</strong> {{ $repair->customer->phone ?? '---' }}
                </div>
            </div>

            <div class="mb-3">
                <strong>ููุน ุงูุฌูุงุฒ:</strong> {{ $repair->device_type }}
            </div>

            <div class="mb-3">
                <strong>ูุตู ุงูุนุทู:</strong> @if($repair->spareParts->isNotEmpty())
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>ุงุณู ูุทุนุฉ ุงูุบูุงุฑ</th>
                <th>ุณุนุฑ ุงููุทุนุฉ</th>
                <th>ุงููููุฉ</th>
            </tr>
        </thead>
        <tbody>
            @foreach($repair->spareParts as $sparePart)
                <tr>
                    <td>{{ $sparePart->name }}</td>
                    <td>{{ number_format($sparePart->sale_price, 2) }} ุฌููู</td>
                    <td>{{ $sparePart->pivot->quantity }}</td>
                </tr>
            @endforeach
        </tbody>
    </table>
@else
    <p>ูุง ุชูุฌุฏ ูุทุน ุบูุงุฑ ูุฑููุฉ.</p>
@endif

            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>ูุทุนุฉ ุงูุบูุงุฑ:</strong> {{ $repair->sparePart->name ?? '---' }}
                </div>
                <div class="col-md-6">
                    <strong>ุณุนุฑ ุงููุทุนุฉ:</strong>
                    {{ $repair->sparePart ? number_format($repair->sparePart->sale_price, 2) . ' ุฌููู' : '---' }}
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>ุชูููุฉ ุงููุตูุนูุฉ:</strong> {{ number_format($repair->repair_cost, 2) }} ุฌููู
                </div>
                <div class="col-md-4">
                    <strong>ุงูุฎุตู:</strong> {{ number_format($repair->discount, 2) }} ุฌููู
                </div>
                <div class="col-md-4">
                    <strong>ุงูุฅุฌูุงูู:</strong> {{ number_format($repair->total, 2) }} ุฌููู
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>ุงููุฏููุน:</strong> {{ number_format($repair->payments->sum('amount'), 2) }} ุฌููู
                </div>
                <div class="col-md-4">
                    <strong>ุงููุชุจูู:</strong> {{ number_format($repair->total - $repair->payments->sum('amount'), 2) }} ุฌููู
                </div>
                <div class="col-md-4">
                    <strong>ุงูุญุงูุฉ:</strong>
                    <span class="badge bg-{{ $repair->status === 'ุชู ุงูุฅุตูุงุญ' ? 'success' : ($repair->status === 'ูู ูุชู ุงูุฅุตูุงุญ' ? 'danger' : 'warning') }}">
                        {{ $repair->status }}
                    </span>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>ุชุงุฑูุฎ ุงูุฅูุดุงุก:</strong> {{ $repair->created_at->format('Y-m-d H:i') }}
                </div>
                <div class="col-md-4">
                    <strong>ุญุงูุฉ ุงูุชุณููู:</strong>
                    <span class="badge bg-{{ $repair->delivery_status === 'delivered' ? 'success' : ($repair->delivery_status === 'rejected' ? 'danger' : 'secondary') }}">
                        {{ $repair->delivery_status === 'delivered' ? 'ุชู ุงูุชุณููู' : ($repair->delivery_status === 'rejected' ? 'ุงูุฌูุงุฒ ูุฑููุถ - ุงุณุชุฑุฌุงุน ุงููุจูุบ' : 'ูู ูุชู ุงูุชุณููู') }}
                    </span>
                </div>
            </div>

            @if($repair->total - $repair->payments->sum('amount') > 0)
                <a href="{{ route('admin.repairs.payments.create', $repair->id) }}" class="btn btn-success mb-3">
                    ๐ต ุณุฏุงุฏ ุงููุชุจูู
                </a>
            @endif

            @if($repair->payments->count() > 0)
                <h5>๐ณ ุงูุฏูุนุงุช ุงูุณุงุจูุฉ:</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="thead-light">
                            <tr>
                                <th>ุงููุจูุบ</th>
                                <th>ุงูุชุงุฑูุฎ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach($repair->payments as $payment)
                                <tr>
                                    <td>{{ number_format($payment->amount, 2) }} ุฌููู</td>
                                    <td>{{ $payment->created_at->format('Y-m-d H:i') }}</td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            @endif

        </div>
    </div>
</div>
@endsection

@push('scripts')
<script>
    const store = @json($globalSetting);
    const repair = @json($repair);
    const sparePart = @json($repair->sparePart);

    function printReceipt(mode = 'a4') {
        const isThermal = mode === 'thermal';

        const content = `
            <div class="invoice-wrapper">
                <div class="header">
                    ${store.logo_url ? `<img src="${store.logo_url}" class="logo">` : ''}
                    <h2>${store.store_name}</h2>
                    <p>${store.address}</p>
                    <p>${store.phone}</p>
                    <hr>
                </div>

                <div class="section">
                    <p><strong>ูุงุชูุฑุฉ ุตูุงูุฉ ุฑูู:</strong> #${repair.id}</p>
                    <p><strong>ุงูุชุงุฑูุฎ:</strong> ${new Date(repair.created_at).toLocaleString()}</p>
                </div>

                <div class="section">
                    <p><strong>ุงูุนููู:</strong> ${repair.customer?.name || repair.customer_name || '---'}</p>
                    <p><strong>ุฑูู ุงููุงุชู:</strong> ${repair.customer?.phone || '---'}</p>
                </div>

                <hr>
                <style>
                    table th {
                        font-size: 13px; /* ุฃู ุงุฎุชุฑ ุงูุญุฌู ุงูุฐู ููุงุณุจู */
                    }
                        table td {
                        font-size: 12px; /* ุฃู ุงุฎุชุฑ ุงูุญุฌู ุงูุฐู ููุงุณุจู */
                    }
                </style>
                <div class="section">

                    <p><strong>ููุน ุงูุฌูุงุฒ:</strong> ${repair.device_type}</p>
                    <p><strong>ูุตู ุงูุนุทู:</strong> ${repair.problem_description}</p>
                    <p><strong>ูุทุน ุงูุบูุงุฑ:</strong></p>
                            @if($repair->spareParts->isNotEmpty())
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ุงุณู ูุทุนุฉ ุงูุบูุงุฑ</th>
                                            <th>ุงููููุฉ</th>
                                            <th>ุณุนุฑ ุงููุทุนุฉ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach($repair->spareParts as $sparePart)
                                            <tr>
                                                <td>{{ $sparePart->name }}</td>
                                                <td>{{ $sparePart->pivot->quantity }}</td>
                                                <td>{{ number_format($sparePart->sale_price, 2) }} ุฌููู</td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            @else
                                <p>ูุง ุชูุฌุฏ ูุทุน ุบูุงุฑ ูุฑููุฉ.</p>
                            @endif


                </div>

                <hr>

                <div class="section total">
                    <p><strong>ุชูููุฉ ุงููุตูุนูุฉ:</strong> ${parseFloat(repair.repair_cost).toFixed(2)} ุฌููู</p>
                    <p><strong>ุงูุฎุตู:</strong> ${parseFloat(repair.discount || 0).toFixed(2)} ุฌููู</p>
                    <p><strong>ุงูุฅุฌูุงูู:</strong> ${parseFloat(repair.total).toFixed(2)} ุฌููู</p>
                    <p><strong>ุงููุฏููุน:</strong> ${parseFloat(repair.payments.reduce((acc, p) => acc + p.amount, 0)).toFixed(2)} ุฌููู</p>
                    <p><strong>ุงููุชุจูู:</strong> ${(parseFloat(repair.total) - parseFloat(repair.payments.reduce((acc, p) => acc + p.amount, 0))).toFixed(2)} ุฌููู</p>
                    <p><strong>ุงูุญุงูุฉ:</strong> ${repair.status}</p>
                </div>

                <hr>

                ${store.invoice_footer ? `<div class="footer">${store.invoice_footer} </br>ุชุตููู ูุจุฑูุฌุฉ ุณุชูุจ ุฌุฑูุจ ููุจุฑูุฌูุงุช 01030889618</div>` : ''}

            </div>
        `;

        const styles = `
            <style>
                body {
                    font-family: Tahoma, Arial, sans-serif;
                    direction: rtl;
                    text-align: right;
                    margin: 0;
                    padding: 20px;
                    font-size: ${isThermal ? '12px' : '14px'};
                }
                .invoice-wrapper {
                    max-width: ${isThermal ? '250px' : '700px'};
                    margin: auto;
                }
                .logo {
                    max-height: 80px;
                    display: block;
                    margin: 0 auto 10px;
                }
                h2 {
                    text-align: center;
                    margin: 5px 0;
                    font-size: ${isThermal ? '16px' : '22px'};
                }
                .section {
                    margin-bottom: 10px;
                }
                .section p {
                    margin: 3px 0;
                }
                .total p {
                    font-weight: bold;
                }
                hr {
                    border: 1px dashed #aaa;
                    margin: 10px 0;
                }
                .footer {
                    text-align: center;
                    margin-top: 10px;
                    font-size: ${isThermal ? '10px' : '13px'};
                }
                @page {
                    size: ${isThermal ? '80mm auto' : 'A4'};
                    margin: 10mm;
                }
            </style>
        `;

        const win = window.open('', '', 'width=800,height=600');
        win.document.write(`<html><head><title>ูุงุชูุฑุฉ ุงูุตูุงูุฉ</title>${styles}</head><body>${content}</body></html>`);
        win.document.close();
        win.focus();
        setTimeout(() => {
            win.print();
            win.close();
        }, 500);
    }
</script>
@endpush

